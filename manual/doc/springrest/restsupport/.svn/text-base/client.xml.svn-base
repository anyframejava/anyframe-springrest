<chapter id="springrest_restsupport_resttemplate">
	<title>Implementing REST Client</title>
	<para>
		지금까지 위에서 설명한 내용들은 모두 서버측 구현과 관련된 내용이었다. RestTemplate은 REST 아키텍처에서 클라이언트 구현과 관련된 내용이다.
	</para>
	<para>
		RestTemplate은 Spring에서 제공하고 있는 JdbcTemplate이나, JmsTemplate과 같은 맥락의 Template으로,
		RESTful Service 호출과 관련된 여러 메소드를 제공하여 REST 클라이언트를 쉽게 개발할 수 있도록 도와주는 것이다.
		<emphasis role="bold">RestTemplate에서 Java 객체를 HTTP Request로 변환하거나 서버로 부터 전달된 HTTP Response를 다시 Java 객체로 변환할 때 HttpMessageConverter가 사용된다.</emphasis>
		Spring에서 제공하는 주요 타입에 대한 HttpMessageConverter들은 RestTemplate에 디폴트로 등록된다. 그 외에 추가가 필요한 경우, RestTemplate을 정의할 때 <emphasis role="bold">messageConverters</emphasis>라는 속성을 이용한다.
	</para>
	<section id="springrest_restsupport_resttemplate_configuration">
		<title>Configuration</title>
		<para>
			RestTemplate 역시 Spring 컨테이너에 Bean으로 정의하고, 참조할 클래스에서 Injection 받아 사용한다.
			다음은 springrest plugin의 src/test/resources/context-restclient.xml파일의 일부이다.
			<programlisting language="xml"><emphasis role="bold"><![CDATA[<bean id="restTemplate" class="org.springframework.web.client.RestTemplate" />]]></emphasis></programlisting>
		</para>
		<para>
			RestTemplate에서도 HTTP Request 메세지를 구성하거나, Response 메세지를 파싱할 때 HttpMessageConverter를 사용한다.
			디폴트로 등록된 HttpMessageConverter를 변경하거나 새로운 HttpMessageConverter를 추가하려면 <emphasis role="bold">messageConverters</emphasis> 속성을 사용한다.
			<programlisting language="xml"><emphasis role="bold"><![CDATA[<bean id="restTemplate" class="org.springframework.web.client.RestTemplate">
    <property name="messageConverters">
        <list>
            <bean class="my.custom.MarshallingHttpMessageConverter">
                <property name="unmarshaller" ref="marshaller" />
                <property name="marshaller" ref="marshaller"/>
            </bean>
        </list>
    </property>
</bean>]]></emphasis></programlisting>
		</para>
	</section>
	
	<section id="springrest_restsupport_resttemplate_resttemplate">
		<title>RestTemplate</title>
		<para>
			RestTemplate은 GET, POST 등 모든 HTTP Method를 사용하여 쉽고 간편하게 RESTful 웹 서비스를 호출할 수 있도록 다음과 같은 메소드를 제공하고 있다.
		</para>
		<para>
			<informaltable>
	    		<tgroup cols="2">
	    			<colspec colname="col1" colnum="1" colwidth="3*" />
			        <colspec colname="col2" colnum="2" colwidth="7*" />
		
			        <thead>
			        	<row>
			            	<entry align="center">HTTP</entry>
			            	<entry align="center">Method</entry>
			          	</row>
			        </thead>
		
		 	        <tbody>
						<row>
							<entry>DELETE</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#delete(java.lang.String, java.lang.Object...)">delete(java.lang.String, java.lang.Object...)</ulink></entry>
			          	</row>
						<row>
							<entry>GET</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#getForObject(java.lang.String, java.lang.Class, java.lang.Object...)">getForObject(java.lang.String, java.lang.Class, java.lang.Object...)</ulink></entry>
			          	</row>	
			          	<row>
							<entry></entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#getForEntity(java.lang.String, java.lang.Class, java.lang.Object...)">getForEntity(java.lang.String, java.lang.Class, java.lang.Object...)</ulink></entry>
			          	</row>
						<row>
							<entry>HEAD</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#headForHeaders(String, String...)">headForHeaders(java.lang.String, java.lang.Object...)</ulink></entry>
			          	</row>	
						<row>
							<entry>OPTIONS</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#optionsForAllow(String, String...)">optionsForAllow(java.lang.String, java.lang.Object...)</ulink></entry>
			          	</row>	
						<row>
							<entry>POST</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#postForLocation(String, Object, String...)">postForLocation(java.lang.String, java.lang.Object, java.lang.Object...)</ulink></entry>
			          	</row>
			          	<row>
							<entry></entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#postForObject(java.lang.String, java.lang.Object, java.lang.Class, java.lang.Object...)">postForObject(java.lang.String, java.lang.Object, java.lang.Class, java.lang.Object...)</ulink></entry>
			          	</row>	
						<row>
							<entry>PUT</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#put(String, Object, String...)">put(java.lang.String, java.lang.Object, java.lang.Object...)</ulink></entry>
			          	</row>
			          	<row>
							<entry>any</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#exchange(java.lang.String, org.springframework.http.HttpMethod, org.springframework.http.HttpEntity, java.lang.Class, java.lang.Object...)">exchange(java.lang.String, org.springframework.http.HttpMethod, org.springframework.http.HttpEntity, java.lang.Class, java.lang.Object...)</ulink></entry>
			          	</row>
			          	<row>
							<entry>&nbsp;</entry>
							<entry><ulink url="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/web/client/RestTemplate.html#execute(java.lang.String, org.springframework.http.HttpMethod, org.springframework.web.client.RequestCallback, org.springframework.web.client.ResponseExtractor, java.lang.Object...)">execute(java.lang.String, org.springframework.http.HttpMethod, org.springframework.web.client.RequestCallback, org.springframework.web.client.ResponseExtractor, java.lang.Object...)</ulink></entry>
			          	</row>
					</tbody>
				</tgroup>
			</informaltable>
		</para>
		
		<para>
			RestTemplate에서 제공하는 getForObject() 메소드를 사용하면 서버로부터 어떤 리소스를 조회하는 기능을 구현할 수 있고, 
			postForLocation() 메소드를 사용하면 서버 측에 리소스를 생성하거나 수정하는 기능을 구현할 수 있다.
		</para>
		
		<para>
			다음은 springrest plugin의 TestCase에서 RestTemplate을 사용한 예이다. 
			코드에서 볼 수 있듯이 RESTful 서비스를 호출하여 결과를 받아오는 것이 한 줄의 코드로 처리가 가능하다. 
			<programlisting language="java">@Inject
@Named("restTemplate")
private RestTemplate restTemplate;

@Test
public void findMovie() {
    String movieId = "MV-00005";
    String movieSearchUrl = "http://localhost:8080/mypjt2/movies/{movieId}";

    Movie movie = restTemplate.getForObject(movieSearchUrl, Movie.class,
        movieId);

    assertThat(movie.getMovieId(), is(movieId));
}</programlisting>
		</para>
		
		<para>
			RestTemplate의 메소드들은 모두 URI Template을 사용하여 요청 URI를 명시할 수 있다.
			<programlisting language="java"><![CDATA[String result = restTemplate.getForObject("http://localhost:8080/testrest/springrest/movies/{movieId}/edit.xml", Movie.class, "MV-00005");]]></programlisting>
		</para>
	
		<para>
			아래와 같이 URI Template의 변수를 Map으로 처리할 수도 있다.
			<programlisting language="java"><![CDATA[Map<String, String> vars = new HashMap<String, String>();
vars.put("movieId", "MV-00005");
String result = restTemplate.getForObject("http://localhost:8080/testrest/springrest/movies/{movieId}/edit.xml", Movie.class, vars);]]></programlisting>
		</para>
		
		<para>
			또한, exchange 메소드를 이용하여 HTTP Response의 header와 body 정보를 자유롭게 사용할 수도 있다.
			<programlisting language="java"><![CDATA[@Test
public void createMovie() throws Exception {
    String movieCreateUrl = "http://localhost:8080/mypjt2/movies";

    Movie movie = makeMovie();

    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_ATOM_XML);
    HttpEntity<Movie> requestEntity = new HttpEntity<Movie>(movie, headers);

    ResponseEntity<String> response = restTemplate.exchange(movieCreateUrl,
        HttpMethod.POST, requestEntity, String.class);
    assertThat(response.getStatusCode().toString(), is("201"));

    String movieSearchUrl = response.getHeaders().getLocation().toURL()
        .toString();
    movie = restTemplate.getForObject(movieSearchUrl, Movie.class);

    assertThat(movie, notNullValue());
    assertThat(movieSearchUrl,
        is("http://localhost:8080/mypjt2/movies/"
            + movie.getMovieId()));
    assertThat(movie.getTitle(), is("괴물"));

    System.out.println("New movie is registered.");
    System.out.println("1.MOVIE ID : " + movieSearchUrl);
    System.out.println("2.MOVIE Object : " + movie);
}]]></programlisting>
		</para>
		
		<note>
			<title>Error Status Code</title>
			<para>
				RestTemplate으로 RESTful 웹 서비스를 호출했을 때, 서버로부터 404나 500 등의 Error Status Code를 리턴을 받게되면 Exception이 발생한다.
				Response Status Code에 대해서는 본 매뉴얼의 <link linkend="springrest_restsupport_contentnegotiation_responsestatuscode">HTTP Response Status Code</link>
				를 참조하기 바란다.
			</para>
		</note>
	</section>
</chapter>